<!doctype html>
<html lang="en">
    <head>
        {% include 'head.html' %}
        <style>
            .pre-search-content {
                display: none;
            }
            .search-container {
                padding-top: 10px !important;
                max-width: 650px;
            }
            .post-search-nav {
                border-bottom: 1px solid #dfe1e5;
                margin-bottom: 20px;
                margin-top: 20px; /* Added gap between search bar and filters */
            }
            .logo-small {
                max-height: 40px;
                margin-right: 15px;
            }
            /* Fix for touch events on mobile triggering HTMX */
            html, body {
                touch-action: manipulation;
                overscroll-behavior-y: none; /* Prevent pull-to-refresh */
            }
            /* Apply touch-action to scrollable elements */
            [id*="container"], [class*="container"], [id*="wrapper"], [class*="wrapper"] {
                touch-action: pan-y;
                overscroll-behavior-y: contain; /* Prevent scroll chain */
            }
            /* Specific handling for search form to prevent unwanted submissions */
            #search {
                touch-action: manipulation;
                overscroll-behavior: none;
            }
            #search input, #search button {
                touch-action: manipulation;
            }
        </style>
    </head>

    <body>
        {% include 'navbar.html' %}

        <div class="container" class="wrapper flex-grow-1 pt-5">
            <div
                class="row justify-content-center pt-5 {% if question %}d-none{% endif %}"
            >
                <div class="col text-center">
                    <h1>
                        <div class="courier-font" style="color: #0f1042">
                            <span style="color: #fe5e00">No</span
                            ><span style="color: #195190ff">bs</span
                            ><span style="color: #0f1042">med</span>
                        </div>
                    </h1>
                </div>
            </div>

            <div
                class="row justify-content-center {% if question %}d-none{% endif %}"
            >
                <div class="col-md-8 text-center">
                    <p class="lead">
                        Search biohacking experiences shared on Reddit
                        <img
                            src="/static/Reddit-Logo.wine.svg"
                            size="24"
                            alt="reddit logo"
                        />
                        and reported in clinical studies.
                    </p>
                </div>
            </div>

            <!-- AI Overview - always hidden -->
            <div id="ai-overview-top" class="d-none">
                <div class="row mb-4">
                    <div class="col-12">
                        <div
                            id="summary-result-top"
                            class="card border-0 shadow-sm"
                            style="border-radius: 8px"
                        >
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center mb-1">
                                    <div class="me-2">
                                        <svg
                                            width="24"
                                            height="24"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            xmlns="http://www.w3.org/2000/svg"
                                        >
                                            <path
                                                d="M12 2L4 6V12C4 17.55 7.84 22.69 12 24C16.16 22.69 20 17.55 20 12V6L12 2Z"
                                                fill="#4285F4"
                                            />
                                        </svg>
                                    </div>
                                    <h4 class="card-title mb-0">AI Overview</h4>
                                </div>

                                <div id="summary-content-top">
                                    <!-- Collapsed view with limited height -->
                                    <div id="summary-collapsed-top" class="card-text mb-3">
                                        <div style="max-height: 180px; overflow: hidden;">
                                            <!-- Card grid layout that stacks on mobile -->
                                            <div class="row row-cols-1 row-cols-md-4 g-3">
                                                <!-- Cool Biohacks Card -->
                                                <div class="col">
                                                    <div class="card h-100 border-primary border-top-0 border-end-0 border-bottom-0 border-3">
                                                        <div class="card-body p-2">
                                                            <h5 class="card-title text-primary fw-bold mb-2">Be curious</h5>
                                                            <div id="cool-biohacks-top" class="card-text">
                                                                <!-- Items will be populated by JavaScript -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Contra Biohacks Card -->
                                                <div class="col">
                                                    <div class="card h-100 border-danger border-top-0 border-end-0 border-bottom-0 border-3">
                                                        <div class="card-body p-2">
                                                            <h5 class="card-title text-danger fw-bold mb-2">Be skeptical</h5>
                                                            <div id="contra-biohacks-top" class="card-text">
                                                                <!-- Items will be populated by JavaScript -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Balance Biohacks Card -->
                                                <div class="col">
                                                    <div class="card h-100 border-info border-top-0 border-end-0 border-bottom-0 border-3">
                                                        <div class="card-body p-2">
                                                            <h5 class="card-title text-info fw-bold mb-2">Be balanced</h5>
                                                            <div id="balance-biohacks-top" class="card-text">
                                                                <!-- Items will be populated by JavaScript -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Mechanisms Card -->
                                                <div class="col">
                                                    <div class="card h-100 border-success border-top-0 border-end-0 border-bottom-0 border-3">
                                                        <div class="card-body p-2">
                                                            <h5 class="card-title text-success fw-bold mb-2">How it works</h5>
                                                            <div id="mechanisms-top" class="card-text">
                                                                <!-- Items will be populated by JavaScript -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Gradient overlay to indicate more content -->
                                        <div style="position: relative; height: 70px; margin-top: -70px; pointer-events: none;">
                                            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 70px; background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Expanded view -->
                                    <div id="summary-expanded-top" class="d-none">
                                        <!-- Card grid layout that stacks on mobile - expanded view -->
                                        <div class="row row-cols-1 row-cols-md-4 g-3">
                                            <!-- Cool Biohacks Card (expanded) -->
                                            <div class="col">
                                                <div class="card h-100 border-primary border-top-0 border-end-0 border-bottom-0 border-3">
                                                    <div class="card-body p-2">
                                                        <h5 class="card-title text-primary fw-bold mb-2">Be curious</h5>
                                                        <div id="cool-biohacks-top-expanded" class="card-text">
                                                            <!-- Items will be populated by JavaScript -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Contra Biohacks Card (expanded) -->
                                            <div class="col">
                                                <div class="card h-100 border-danger border-top-0 border-end-0 border-bottom-0 border-3">
                                                    <div class="card-body p-2">
                                                        <h5 class="card-title text-danger fw-bold mb-2">Be skeptical</h5>
                                                        <div id="contra-biohacks-top-expanded" class="card-text">
                                                            <!-- Items will be populated by JavaScript -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Balance Biohacks Card (expanded) -->
                                            <div class="col">
                                                <div class="card h-100 border-info border-top-0 border-end-0 border-bottom-0 border-3">
                                                    <div class="card-body p-2">
                                                        <h5 class="card-title text-info fw-bold mb-2">Be balanced</h5>
                                                        <div id="balance-biohacks-top-expanded" class="card-text">
                                                            <!-- Items will be populated by JavaScript -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Mechanisms Card (expanded) -->
                                            <div class="col">
                                                <div class="card h-100 border-success border-top-0 border-end-0 border-bottom-0 border-3">
                                                    <div class="card-body p-2">
                                                        <h5 class="card-title text-success fw-bold mb-2">How it works</h5>
                                                        <div id="mechanisms-top-expanded" class="card-text">
                                                            <!-- Items will be populated by JavaScript -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Toggle button for show more/show less -->
                                    <div class="text-center">
                                        <button id="show-more-btn-top" class="btn btn-outline-secondary rounded-pill px-4 py-1" onclick="toggleSummaryTop()">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1">
                                                <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path>
                                            </svg>
                                            Show more
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google-style search bar -->
            <div class="row {% if question %}pt-2{% else %}pt-5{% endif %}">
                <div
                    class="{% if question %}col-md-12 d-flex{% else %}col-md-8 mx-auto{% endif %}"
                >
                    <form
                        id="search"
                        hx-get="/search"
                        hx-headers='{"XXXXXXXX": "XXXXXXXXX"}'
                        hx-trigger="submit"
                        hx-target="#search-results"
                        hx-swap="innerHTML"
                        hx-push-url="true"
                        hx-on:submit="if(!document.getElementById('example-search-input').value.trim()) { hideAllSpinners(); return false; } return preventSubmitOnSwipe(event) && showSpinner();"
                        class="{% if question %}d-flex w-100{% endif %}"
                        data-touch-action="auto"
                    >
                        <!-- Search bar with shadow -->
                        <div
                            class="{% if question %}flex-grow-1{% else %}position-relative mb-4{% endif %}"
                        >
                            <div class="input-group shadow-sm">
                                <span
                                    class="input-group-text bg-white border-end-0 rounded-start-pill"
                                >
                                    <i class="bi bi-search text-secondary"></i>
                                </span>
                                <input
                                    class="form-control border-start-0 rounded-end-pill"
                                    type="text"
                                    name="question"
                                    id="example-search-input"
                                    required
                                    placeholder="Search biohacking experiences"
                                    value="{% if question %}{{question}}{% endif %}"
                                />
                            </div>
                        </div>

                        <!-- Google-style buttons centered -->
                        <div
                            class="{% if question %}ms-2 d-flex align-items-center{% else %}d-flex justify-content-center gap-2 mt-4{% endif %}"
                        >
                            <button
                                class="btn {% if question %}btn-primary btn-sm{% else %}btn-light py-2 px-3{% endif %}"
                                type="submit"
                                id="search-button"
                            >
                                <span id="search-text">Search</span>
                                <span id="button-spinner" style="display: none; width: 20px; height: 20px;">
                                    <img src="/static/svg-loaders/three-dots.svg" alt="Loading..." width="20" height="20">
                                </span>
                            </button>
                            {% if not question %}
                            <button
                                class="btn btn-light py-2 px-3"
                                type="button"
                                id="feeling-lucky"
                                onclick="feelingLuckyWithSpinner()"
                            >
                                <span id="lucky-text">I'm Feeling Lucky</span>
                                <span id="lucky-spinner" style="display: none; width: 20px; height: 20px;">
                                    <img src="/static/svg-loaders/three-dots.svg" alt="Loading..." width="20" height="20">
                                </span>
                            </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            <!-- Script for I'm Feeling Lucky button and Search spinner -->
            <script>
                // Show spinner in search button and the main spinner only if input is valid
                function showSpinner() {
                    // Check if the input field has a value
                    const searchInput = document.getElementById('example-search-input');
                    if (!searchInput || !searchInput.value.trim()) {
                        console.log("Empty search input - not showing spinner");
                        return false; // Don't show spinner if no data
                    }
                    
                    // Input has content, show spinners
                    console.log("Valid search input - showing spinner");
                    document.getElementById('search-text').style.display = 'none';
                    document.getElementById('button-spinner').style.display = 'inline-block';
                    document.getElementById('search-spinner').style.display = 'block';
                    return true;
                }
                
                // Regular feeling lucky function
                function feelingLucky() {
                    const luckyQuestions = [
                        "how to improve sleep naturally",
                        "best supplements for mental focus",
                        "intermittent fasting benefits",
                        "nootropics for brain health",
                        "meditation benefits for stress",
                    ];
                    const randomIndex = Math.floor(
                        Math.random() * luckyQuestions.length
                    );
                    document.getElementById("example-search-input").value =
                        luckyQuestions[randomIndex];
                    document.getElementById("search").submit();
                }
                
                // Feeling lucky with spinner
                function feelingLuckyWithSpinner() {
                    // Show both spinners
                    document.getElementById('lucky-text').style.display = 'none';
                    document.getElementById('lucky-spinner').style.display = 'inline-block';
                    document.getElementById('search-spinner').style.display = 'block';
                    
                    // Call the original function
                    feelingLucky();
                }
                
                // Function to hide all spinners
                function hideAllSpinners() {
                    document.getElementById('search-text').style.display = 'inline';
                    document.getElementById('button-spinner').style.display = 'none';
                    document.getElementById('search-spinner').style.display = 'none';
                    
                    if (document.getElementById('lucky-text')) {
                        document.getElementById('lucky-text').style.display = 'inline';
                    }
                    if (document.getElementById('lucky-spinner')) {
                        document.getElementById('lucky-spinner').style.display = 'none';
                    }
                }
                
                // Add event listeners to detect when the page finishes loading
                document.addEventListener('htmx:afterOnLoad', hideAllSpinners);
                document.addEventListener('htmx:afterRequest', hideAllSpinners);
                document.addEventListener('htmx:afterSwap', hideAllSpinners);
                
                // Also set a timeout to hide spinners if HTMX events don't fire
                window.addEventListener('load', function() {
                    setTimeout(hideAllSpinners, 5000);
                });
                
                // Add validation to form submission
                document.addEventListener('DOMContentLoaded', function() {
                    const searchForm = document.getElementById('search');
                    if (searchForm) {
                        // Intercept form submission
                        searchForm.addEventListener('submit', function(event) {
                            // Get the search input and check if it's empty
                            const searchInput = document.getElementById('example-search-input');
                            if (!searchInput || !searchInput.value.trim()) {
                                console.log("Empty search prevented");
                                event.preventDefault(); // Prevent form submission for empty input
                                hideAllSpinners(); // Make sure spinners are hidden
                                return false;
                            }
                            
                            // Valid input, show spinner
                            return showSpinner();
                        });
                    }
                });
            </script>
            <!-- End Google-style search bar -->

            {% block ai_search_results %}

            <!-- This wrapper contains ALL search content -->
            <div id="full-search-results">
                {% if question %}
                <!-- Move everything up for post-search results UI -->
                {% endif %}

                <!-- Loading indicator for search -->
                <div id="search-spinner" class="position-relative my-3 text-center" style="display: none;">
                    <div class="d-inline-block">
                        <img src="/static/svg-loaders/puff.svg" alt="Loading..." width="40" height="40">
                        <span class="ms-2">Searching experiences...</span>
                    </div>
                </div>
                
                <!-- search-results - direct target for HTMX updates -->
                <div id="search-results" class="mt-3">
                    <!-- This container will be targeted by the summary HTMX updates - sticky at the top when scrolling -->
                    <div
                        id="summary-area"
                        {% if not summary_polling == "finished" %}class="sticky-top"{% endif %}
                        style="
                            top: 5px;
                            z-index: 1000;
                            background-color: white;
                            padding: 5px 0;
                            margin-bottom: 0;
                            {% if not summary_polling == "finished" %}box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);{% endif %}
                        "
                    >
                        {% block ai_summary %} {% if summary_polling == "on" %}
                        <!-- Fixed container for summary polling with consistent ID -->
                        <div id="summary-container-wrapper" class="d-none">
                            <!-- ID must match the target in the HTMX call -->
                            <div
                                id="summary-container"
                                data-disabled-get="/poll_ai_summary/{{question}}"
                                data-disabled-trigger="load delay:250ms"
                                data-disabled-target="#summary-container-wrapper"
                                data-disabled-swap="innerHTML"
                                data-disabled-headers='{"traceparent": "{{traceparent}}" }'
                            >
                                <div
                                    class="progress d-none"
                                    style="height: 30px"
                                    role="progressbar"
                                    aria-label="Animated striped example"
                                    aria-valuenow="75"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                >
                                    <div
                                        class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                        style="width: 100%"
                                    >
                                        Summarizing biohacking experiences...
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %} {% if summary_polling ==
                        "finished_due_to_error" %}
                        <div
                            id="summary-error"
                            class="card mb-2 border-0 shadow-sm"
                            style="border-radius: 8px"
                        >
                            {{ai_summary_error_message}}
                        </div>
                        {% endif %} {% if summary_polling == "finished" %}
                        <div
                            id="summary-result"
                            class="card mb-2 border-0 shadow-sm d-none"
                            style="border-radius: 8px"
                        >
                            <div class="card-body py-2 px-3">
                                <div class="d-flex align-items-center mb-1">
                                    <div class="me-2">
                                        <svg
                                            width="24"
                                            height="24"
                                            viewBox="0 0 24 24"
                                            fill="none"
                                            xmlns="http://www.w3.org/2000/svg"
                                        >
                                            <path
                                                d="M12 2L4 6V12C4 17.55 7.84 22.69 12 24C16.16 22.69 20 17.55 20 12V6L12 2Z"
                                                fill="#4285F4"
                                            />
                                        </svg>
                                    </div>
                                    <h4 class="card-title mb-0">AI Overview</h4>
                                </div>

                                <div id="summary-content">
                                    <!-- Hidden container to store mechanisms data -->
                                    <div id="hidden-mechanisms" class="d-none" data-mechanisms='{% if mechanisms %}{{ mechanisms|tojson }}{% endif %}'></div>
                                    
                                    <div id="summary-collapsed">
                                        <div
                                            class="card-text mb-3"
                                            style="
                                                max-height: 180px;
                                                overflow: hidden;
                                            "
                                        >
                                            <!-- Three-column layout for biohack lists -->
                                            <div class="row">
                                                <!-- Cool Biohacks -->
                                                <div class="col-md-4">
                                                    <h5
                                                        class="text-primary fw-bold mb-2"
                                                    >
                                                        Be curious
                                                    </h5>
                                                    <ul
                                                        class="list-group list-group-flush"
                                                    >
                                                        {% for item in
                                                        cool_biohacks %}
                                                        <li
                                                            class="list-group-item px-0 py-1 border-0"
                                                        >
                                                            <i
                                                                class="bi bi-check-circle-fill text-success me-1"
                                                            ></i>
                                                            {{item |safe}}
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>

                                                <!-- Contra Biohacks -->
                                                <div class="col-md-4">
                                                    <h5
                                                        class="text-danger fw-bold mb-2"
                                                    >
                                                        Be skeptical
                                                    </h5>
                                                    <ul
                                                        class="list-group list-group-flush"
                                                    >
                                                        {% for item in
                                                        contra_biohacks %}
                                                        <li
                                                            class="list-group-item px-0 py-1 border-0"
                                                        >
                                                            <i
                                                                class="bi bi-exclamation-triangle-fill text-warning me-1"
                                                            ></i>
                                                            {{item |safe}}
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>

                                                <!-- Balance Biohacks -->
                                                <div class="col-md-4">
                                                    <h5
                                                        class="text-info fw-bold mb-2"
                                                    >
                                                        Be balanced
                                                    </h5>
                                                    <ul
                                                        class="list-group list-group-flush"
                                                    >
                                                        {% for item in
                                                        balance_biohacks %}
                                                        <li
                                                            class="list-group-item px-0 py-1 border-0"
                                                        >
                                                            <i
                                                                class="bi bi-arrow-repeat text-info me-1"
                                                            ></i>
                                                            {{item | safe}}
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            style="
                                                position: relative;
                                                height: 70px;
                                                margin-top: -70px;
                                                pointer-events: none;
                                            "
                                        >
                                            <div
                                                style="
                                                    position: absolute;
                                                    bottom: 0;
                                                    left: 0;
                                                    right: 0;
                                                    height: 70px;
                                                    background: linear-gradient(
                                                        to bottom,
                                                        rgba(255, 255, 255, 0),
                                                        rgba(255, 255, 255, 1)
                                                    );
                                                "
                                            ></div>
                                        </div>
                                    </div>

                                    <div id="summary-expanded" class="d-none">
                                        <div class="card-text">
                                            <!-- Three-column layout for biohack lists (expanded view) -->
                                            <div class="row">
                                                <!-- Cool Biohacks -->
                                                <div class="col-md-4">
                                                    <h5
                                                        class="text-primary fw-bold mb-2"
                                                    >
                                                        Cool Biohack Outcomes
                                                    </h5>
                                                    <ul
                                                        class="list-group list-group-flush"
                                                    >
                                                        {% for item in
                                                        cool_biohacks %}
                                                        <li
                                                            class="list-group-item px-0 py-1 border-0"
                                                        >
                                                            <i
                                                                class="bi bi-check-circle-fill text-success me-1"
                                                            ></i>
                                                            {{item |safe}}
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>

                                                <!-- Contra Biohacks -->
                                                <div class="col-md-4">
                                                    <h5
                                                        class="text-danger fw-bold mb-2"
                                                    >
                                                        Contra Biohacks
                                                    </h5>
                                                    <ul
                                                        class="list-group list-group-flush"
                                                    >
                                                        {% for item in
                                                        contra_biohacks %}
                                                        <li
                                                            class="list-group-item px-0 py-1 border-0"
                                                        >
                                                            <i
                                                                class="bi bi-exclamation-triangle-fill text-warning me-1"
                                                            ></i>
                                                            {{item |safe}}
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>

                                                <!-- Balance Biohacks -->
                                                <div class="col-md-4">
                                                    <h5
                                                        class="text-info fw-bold mb-2"
                                                    >
                                                        Balance Biohacks
                                                    </h5>
                                                    <ul
                                                        class="list-group list-group-flush"
                                                    >
                                                        {% for item in
                                                        balance_biohacks %}
                                                        <li
                                                            class="list-group-item px-0 py-1 border-0"
                                                        >
                                                            <i
                                                                class="bi bi-arrow-repeat text-info me-1"
                                                            ></i>
                                                            {{item |safe}}
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button
                                        id="show-more-btn"
                                        class="btn btn-outline-secondary rounded-pill px-4 py-1"
                                        onclick="toggleSummary()"
                                    >
                                        <svg
                                            width="16"
                                            height="16"
                                            viewBox="0 0 24 24"
                                            fill="currentColor"
                                            class="me-1"
                                        >
                                            <path
                                                d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"
                                            ></path>
                                        </svg>
                                        Show more
                                    </button>
                                </div>
                            </div>
                        </div>

                        <script>
                            // Always show the button for consistency with Google's interface
                            function toggleSummary() {
                                const collapsed =
                                    document.getElementById(
                                        "summary-collapsed"
                                    );
                                const expanded =
                                    document.getElementById("summary-expanded");
                                const button =
                                    document.getElementById("show-more-btn");

                                if (collapsed.classList.contains("d-none")) {
                                    // Currently showing expanded view, switch to collapsed
                                    collapsed.classList.remove("d-none");
                                    expanded.classList.add("d-none");
                                    button.innerHTML =
                                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg> Show more';
                                } else {
                                    // Currently showing collapsed view, switch to expanded
                                    collapsed.classList.add("d-none");
                                    expanded.classList.remove("d-none");
                                    button.innerHTML =
                                        '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"></path></svg> Show less';
                                }
                            }
                        </script>
                        {% endif %} {% endblock %}
                    </div>

                    {% if relevance_polling == "on" and summary_polling == "off"
                    %}
                    <!-- Fixed polling container with transition handling -->
                    <div
                        id="relevance-polling-container"
                        class="sticky-top mb-2 d-none"
                        style="
                            top: 5px;
                            z-index: 1000;
                            background-color: white;
                            padding: 5px 0;
                            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
                            transition: top 0.3s ease;
                            position: sticky;
                        "
                    >
                        <!-- This inner div is what HTMX replaces - with transition handling -->
                        <div
                            id="relevance-polling-progress"
                            {% if question %}data-disabled-get="/poll_ai_search/{{question}}"{% endif %}
                            {% if question %}data-disabled-trigger="load delay:200ms"{% endif %}
                            data-disabled-target="#relevance-polling-container"
                            data-disabled-swap="innerHTML"
                            data-disabled-headers='{"traceparent": "{{traceparent}}", "first_poll": "{{first_poll}}"}'
                            data-touch-action="auto"
                        >
                            <div
                                class="progress d-none"
                                style="height: 30px"
                                role="progressbar"
                                aria-label="Animated striped example"
                                aria-valuenow="50"
                                aria-valuemin="0"
                                aria-valuemax="100"
                            >
                                <div
                                    class="progress-bar progress-bar-striped progress-bar-animated"
                                    style="width: 100%"
                                >
                                    Filtering {{count_experiences}} experiences
                                    for `{{question}}`
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %} {% if relevance_polling == "finished" or relevance_polling == "on" %}

                    <!-- Style for compact filter layout -->
                    <style>
                        #filter-nav button {
                            margin-top: 2px;
                            margin-bottom: 2px;
                            padding: 0.25rem 0.5rem;
                        }
                        .post-search-nav {
                            transition: top 0.3s ease;
                        }
                    </style>

                    <!-- Filter navigation - sticky when scrolling - with minimal padding -->
                    <div
                        id="filter-nav"
                        class="post-search-nav sticky-top"
                        style="
                            top: 80px;
                            z-index: 999;
                            background-color: white;
                            padding: 8px 0 5px 0;
                            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
                            margin-top: 0;
                            border-top: 1px solid #eee;
                        "
                    >
                        <!-- Row 1: Source Type Filters - minimal padding -->
                        <div class="row mb-1 pb-1 pt-1 border-bottom">
                            <div class="col-12">
                                <div
                                    class="d-flex flex-wrap gap-3 align-items-center"
                                >
                                    <a 
                                        href="#all-sources" 
                                        class="btn btn-sm btn-outline-secondary active"
                                        onclick="filterSourceType('all'); return false;"
                                    >
                                        All sources
                                    </a>
                                    <a 
                                        href="#reddit-sources" 
                                        class="btn btn-sm btn-outline-secondary"
                                        onclick="filterSourceType('reddit'); return false;"
                                        id="reddit-filter-btn"
                                    >
                                        {% if count_reddits == 1 %} 1 Personal
                                        experience {% else %}
                                        {{count_reddits|default(0)}} Personal
                                        experiences {% endif %}
                                    </a>
                                    <a 
                                        href="#study-sources" 
                                        class="btn btn-sm btn-outline-secondary"
                                        onclick="filterSourceType('study'); return false;"
                                        id="studies-filter-btn"
                                    >
                                        {% if count_studies == 1 %} 1 Scientific Study {%
                                        else %} {{count_studies|default(0)}}
                                        Scientific Studies {% endif %}
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Biohack Type Filters -->
                        <div class="row mb-2">
                            <div class="col-12">
                                <div
                                    class="d-flex flex-wrap gap-2 align-items-center"
                                >
                                    <div
                                        class="d-flex flex-wrap gap-2 align-items-center"
                                        id="biohack-type-filters"
                                    >
                                        <button
                                            class="btn btn-sm btn-outline-secondary active"
                                            id="all-types-btn"
                                            onclick="filterBiohackType('all'); return false;"
                                        >
                                            All biohack types
                                        </button>
                                        <!-- Additional filter buttons will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        // Trigger filter button generation when results load
                        console.log(
                            "Attempting to generate biohack type filters"
                        );
                        setTimeout(function () {
                            if (
                                typeof generateBiohackTypeFilters === "function"
                            ) {
                                generateBiohackTypeFilters();
                                console.log("Generated biohack type filters");
                            } else {
                                console.error(
                                    "generateBiohackTypeFilters function not found"
                                );
                            }
                        }, 300);

                        // Also try after a longer delay to ensure DOM is fully loaded
                        setTimeout(function () {
                            if (
                                typeof generateBiohackTypeFilters === "function"
                            ) {
                                generateBiohackTypeFilters();
                                console.log(
                                    "Generated biohack type filters (delayed)"
                                );
                            }
                        }, 1000);
                    </script>

                    {% for biohack_type in biohack_types %}
                    <div
                        class="biohack-section"
                        data-type="{{biohack_type.biohack_type|lower|replace(' ', '-')}}"
                    >
                        <h2 class="mb-2">
                            <span class="display-6" style="color: #0066cc"
                                >{{biohack_type.biohack_type}} </span
                            >
                        </h2>
                        <!-- Using grid layout for the cards -->
                        <div
                            class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"
                        >
                            {% for biohack in biohack_type.biohacks %}
                            <div class="col">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h5 class="card-title mb-0">
                                                {{biohack.biohack_topic}}
                                            </h5>
                                            <span class="badge bg-secondary fs-6 ms-2"
                                                >{{biohack.biohack_type}}</span
                                            >
                                        </div>
                                        <div class="mt-3 d-flex align-items-center mb-2" style="margin-left: 12px;">
                                            <div>
                                                <span style="color: #8a4fff; font-weight: 600;" class="small d-block">This biohack led to...</span>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#8a4fff" class="bi bi-arrow-down" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
                                                </svg>
                                            </div>
                                        </div>
                                        <ul class="list-group list-group-flush">
                                            {% for experience in
                                            biohack.experiences %}
                                            <li
                                                class="list-group-item p-2 experience-item"
                                                data-source-type="{{experience.source_type}}"
                                            >
                                                <div
                                                    class="d-flex justify-content-between align-items-start"
                                                >
                                                    <a
                                                        href="{{experience.url}}"
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover me-2"
                                                    >
                                                    <!--
                                                        {{experience.action}}
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right mx-1" viewBox="0 0 16 16">
                                                          <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                                                        </svg>
                                                    -->
                                                        {{experience.outcomes}}
                                                    </a>
                                                    <a
                                                        href="{{experience.url}}"
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                    >
                                                    {% if experience.source_type
                                                    == "reddit" %}
                                                    <span
                                                        class="badge bg-warning text-dark"
                                                        >Personal<br>Experience</span
                                                    >
                                                    {% elif
                                                    experience.source_type ==
                                                    "study" %}
                                                    <span
                                                        class="badge bg-success"
                                                        >Scientific<br>Study</span
                                                    >
                                                    {% else %}
                                                    <span
                                                        class="badge bg-secondary"
                                                        >{{experience.source_type}}</span
                                                    >
                                                    {% endif %}
                                                    </a>
                                                </div>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <!-- end of row -->
                    </div>
                    <!-- end of biohack-section -->
                    {% endfor %}
                    <!-- end of biohack_type loop -->

                    {% endif %}
                    <!-- end if relevance_polling == "finished" -->
                </div>
                <!-- search-results -->
                {% endblock %}
            </div>
            <!-- End of full-search-results wrapper -->
        </div>
        <!-- /.container -->
        {% include 'footer.html' %}

        <!-- JavaScript for managing sticky components -->
        <script>
            // Fix for touch events on mobile triggering HTMX requests
            document.addEventListener("DOMContentLoaded", function() {
                // Variables to track swipe behavior
                let touchStartY = 0;
                let touchMoveY = 0;
                let isSwipingDown = false;

                // Handle touch start - record initial position
                document.body.addEventListener('touchstart', function(e) {
                    touchStartY = e.touches[0].clientY;
                    isSwipingDown = false;
                    // Reset the form's data attribute for swipe prevention
                    const searchForm = document.getElementById('search');
                    if (searchForm) {
                        searchForm.removeAttribute('data-prevent-submit');
                    }
                }, { passive: true });
                
                // Prevent touchmove events from triggering HTMX requests
                document.body.addEventListener('touchmove', function(e) {
                    // Get current touch position
                    touchMoveY = e.touches[0].clientY;
                    
                    // Calculate direction and distance
                    const deltaY = touchMoveY - touchStartY;
                    
                    // If swiping down significantly (more than 30px), mark as downward swipe
                    if (deltaY > 30) {
                        isSwipingDown = true;
                        
                        // Mark the search form to prevent submission
                        const searchForm = document.getElementById('search');
                        if (searchForm) {
                            searchForm.setAttribute('data-prevent-submit', 'true');
                        }
                    }
                    
                    // Add a custom attribute to mark this as a scroll touch
                    e.target.setAttribute('data-touch-scroll', 'true');
                    
                    // Find all touchable HTMX elements and temporarily disable them during scroll
                    const htmxElements = document.querySelectorAll('[hx-trigger]');
                    htmxElements.forEach(function(el) {
                        if (el.getAttribute('hx-trigger').includes('load')) {
                            el.setAttribute('data-original-trigger', el.getAttribute('hx-trigger'));
                            el.removeAttribute('hx-trigger');
                        }
                    });
                }, { passive: true });
                
                // Re-enable HTMX triggers after touch end
                document.body.addEventListener('touchend', function() {
                    setTimeout(function() {
                        const htmxElements = document.querySelectorAll('[data-original-trigger]');
                        htmxElements.forEach(function(el) {
                            el.setAttribute('hx-trigger', el.getAttribute('data-original-trigger'));
                            el.removeAttribute('data-original-trigger');
                        });
                    }, 300); // Short delay to prevent immediate triggering
                }, { passive: true });
            });

            document.addEventListener("DOMContentLoaded", function () {
                // Initial adjustment of positions
                adjustStickyPositions();

                // Adjust positions on window resize
                window.addEventListener("resize", adjustStickyPositions);

                // Adjust positions on scroll
                window.addEventListener("scroll", adjustStickyPositions);

                // Function to adjust positions of all sticky elements
                function adjustStickyPositions() {
                    const summaryArea = document.getElementById("summary-area");
                    const filterNav = document.getElementById("filter-nav");
                    const relevancePollingContainer = document.getElementById("relevance-polling-container");

                    // First handle the summary area and filter nav relationship
                    if (summaryArea && filterNav) {
                        // Calculate summary area's height (including margins)
                        const summaryHeight = summaryArea.offsetHeight;

                        // Set the top position of the filters with minimal padding
                        // Just enough to prevent overlap but keep layout compact
                        filterNav.style.top = summaryHeight + 5 + "px";

                        // Update spacer height for compact layout - reduce gap
                        const spacer = document.getElementById("content-spacer");
                        if (spacer) {
                            // Reduced spacing - only add enough height to clear the sticky elements
                            const totalHeight = summaryHeight + filterNav.offsetHeight + 5;
                            spacer.style.height = totalHeight + "px";
                        }

                        // Keep content from jumping
                        const topContainer = document.getElementById("search-results");
                        if (topContainer) {
                            // Use minimal padding to keep layout compact
                            topContainer.style.paddingTop = "10px";
                        }
                    }
                    
                    // Now handle the relevance polling container positioning
                    if (relevancePollingContainer) {
                        // If summary area exists, position polling below it
                        if (summaryArea && summaryArea.offsetHeight > 0) {
                            const summaryHeight = summaryArea.offsetHeight;
                            relevancePollingContainer.style.top = summaryHeight + 5 + "px";
                        } else {
                            // No summary area or it's empty, position at top
                            relevancePollingContainer.style.top = "5px";
                        }
                    }
                }

                // Also adjust when HTMX content is swapped (in case heights change)
                document.addEventListener("htmx:afterSwap", function (event) {
                    // Use setTimeout to ensure DOM is updated
                    setTimeout(adjustStickyPositions, 100);

                    // Additional adjustment specifically for relevance polling updates
                    if (event.detail.target && 
                        (event.detail.target.id === "relevance-polling-container" || 
                         event.detail.target.id === "relevance-polling-progress")) {
                        console.log("Relevance polling update detected, adjusting positions");
                        // Apply immediate adjustment
                        adjustStickyPositions();
                        // And another adjustment after a short delay to catch rendering changes
                        setTimeout(adjustStickyPositions, 300);
                    }

                    // Also regenerate biohack type filters after HTMX swaps
                    if (typeof generateBiohackTypeFilters === "function") {
                        setTimeout(function () {
                            generateBiohackTypeFilters();
                            console.log(
                                "Generated filters after HTMX swap",
                                event.detail.target.id
                            );
                        }, 300);
                    }
                    
                    // Another position adjustment after everything has settled
                    setTimeout(adjustStickyPositions, 500);
                });
            });
        </script>

        <!-- JavaScript for filtering -->
        <script>
            // Filter by biohack type (categories)
            function filterBiohackType(type) {
                console.log("Filtering by biohack type:", type);

                // Update active button for biohack types
                const allTypesBtn = document.getElementById("all-types-btn");
                const biohackTypeButtons = document.querySelectorAll(
                    "#biohack-type-filters .btn-sm.btn-outline-secondary"
                );

                // Remove active class from all buttons
                if (allTypesBtn) allTypesBtn.classList.remove("active");
                biohackTypeButtons.forEach((btn) =>
                    btn.classList.remove("active")
                );

                // Add active class to the correct button
                if (type === "all") {
                    if (allTypesBtn) allTypesBtn.classList.add("active");
                } else {
                    biohackTypeButtons.forEach((btn) => {
                        if (btn.getAttribute("data-type") === type) {
                            btn.classList.add("active");
                        }
                    });
                }

                // Filter sections
                const sections = document.querySelectorAll(".biohack-section");
                sections.forEach((section) => {
                    if (
                        type === "all" ||
                        section.getAttribute("data-type") === type
                    ) {
                        section.style.display = "block";
                    } else {
                        section.style.display = "none";
                    }
                });
            }

            // Filter by source type (Reddit/Studies)
            function filterSourceType(sourceType) {
                // Update URL hash for deep linking
                if (sourceType === 'all') {
                    window.location.hash = 'all-sources';
                } else if (sourceType === 'reddit') {
                    window.location.hash = 'reddit-sources';
                } else if (sourceType === 'study') {
                    window.location.hash = 'study-sources';
                }
                
                // Update active source type button
                const sourceButtons = document.querySelectorAll(
                    ".post-search-nav .row:first-child a.btn"
                );
                sourceButtons.forEach((button) => {
                    button.classList.remove("active");
                    const buttonId = button.getAttribute("id");
                    if (
                        (sourceType === "all" &&
                            button.textContent.trim() === "All sources") ||
                        (sourceType === "reddit" &&
                            buttonId === "reddit-filter-btn") ||
                        (sourceType === "study" &&
                            buttonId === "studies-filter-btn")
                    ) {
                        button.classList.add("active");
                    }
                });

                // Filter experience items
                const experienceItems =
                    document.querySelectorAll(".experience-item");

                // First, mark all experience items as visible or hidden
                experienceItems.forEach((item) => {
                    const itemSourceType =
                        item.getAttribute("data-source-type");
                    if (sourceType === "all" || itemSourceType === sourceType) {
                        item.style.display = "";
                    } else {
                        item.style.display = "none";
                    }
                });

                // Next, check each card to see if it has any visible experiences
                document.querySelectorAll(".card").forEach((card) => {
                    const cardExperiences =
                        card.querySelectorAll(".experience-item");
                    const hasVisibleExperiences = Array.from(
                        cardExperiences
                    ).some((item) => item.style.display !== "none");

                    // Get the parent column that contains this card
                    const cardColumn = card.closest(".col");
                    if (cardColumn) {
                        if (hasVisibleExperiences) {
                            cardColumn.style.display = "";
                        } else {
                            cardColumn.style.display = "none";
                        }
                    }
                });

                // Finally, check if sections have any visible cards
                document
                    .querySelectorAll(".biohack-section")
                    .forEach((section) => {
                        const sectionCards = section.querySelectorAll(".col");
                        const hasVisibleCards = Array.from(sectionCards).some(
                            (col) => col.style.display !== "none"
                        );

                        if (hasVisibleCards) {
                            section.style.display = "block";
                        } else {
                            section.style.display = "none";
                        }
                    });

                // Update the counts display
                updateFilterCounts(sourceType);
            }

            // Function to generate biohack type filter buttons from sections
            function generateBiohackTypeFilters() {
                // Clear existing filter buttons except the "All Topics" button
                const filterContainer = document.getElementById(
                    "biohack-type-filters"
                );
                if (!filterContainer) return;

                // Keep only the first button (All Topics)
                while (filterContainer.children.length > 1) {
                    filterContainer.removeChild(filterContainer.lastChild);
                }

                // Get all unique biohack types from the sections
                const biohackSections =
                    document.querySelectorAll(".biohack-section");
                const biohackTypes = new Set();

                biohackSections.forEach((section) => {
                    const type = section.getAttribute("data-type");
                    const displayName = section
                        .querySelector(".display-6")
                        .textContent.trim();
                    if (type && displayName) {
                        biohackTypes.add(JSON.stringify({ type, displayName }));
                    }
                });

                // Create a button for each biohack type
                biohackTypes.forEach((typeJson) => {
                    const { type, displayName } = JSON.parse(typeJson);
                    const button = document.createElement("button");
                    button.className = "btn btn-sm btn-outline-secondary";
                    button.setAttribute(
                        "onclick",
                        `filterBiohackType('${type}'); return false;`
                    );
                    button.setAttribute("data-type", type);
                    button.textContent = displayName;
                    filterContainer.appendChild(button);
                });
            }

            // Handle URL hash changes to filter by source type
            function handleHashChange() {
                const hash = window.location.hash;
                if (hash === '#reddit-sources') {
                    filterSourceType('reddit');
                } else if (hash === '#study-sources') {
                    filterSourceType('study');
                } else if (hash === '#all-sources') {
                    filterSourceType('all');
                }
            }
            
            // Handle HTMX events for search functionality
            document.addEventListener('htmx:beforeRequest', function(event) {
                if (event.target.id === 'search') {
                    console.log('Search form submission: preparing for content update');
                    
                    // Clear any existing search results to prevent duplicates
                    const searchResults = document.getElementById('search-results');
                    if (searchResults) {
                        // Save the structure but clear the content
                        const savedStructure = searchResults.innerHTML;
                        
                        // Look for duplicate AI Overviews inside the results
                        const aiOverviews = searchResults.querySelectorAll('#ai-overview-top');
                        if (aiOverviews.length > 0) {
                            console.log('Removing duplicate AI Overview elements before search');
                            aiOverviews.forEach(element => element.remove());
                        }
                        
                        // Look for duplicate search forms inside the results
                        const searchForms = searchResults.querySelectorAll('#search');
                        if (searchForms.length > 0) {
                            console.log('Removing duplicate search forms before search');
                            searchForms.forEach(element => {
                                if (element !== event.target) {
                                    element.remove();
                                }
                            });
                        }
                    }
                }
            });
            
            // Handle HTMX afterSwap to ensure clean DOM
            document.addEventListener('htmx:afterSwap', function(event) {
                console.log('HTMX swap completed for target:', event.detail.target.id);
                
                // After the swap, check for duplicates throughout the page
                
                // 1. Check for duplicate search forms
                const searchForms = document.querySelectorAll('#search');
                if (searchForms.length > 1) {
                    console.warn('Found multiple search forms, keeping only the first one');
                    // Find the main search form (the one at the top of the page)
                    const mainForm = document.querySelector('.row > div > #search');
                    
                    if (mainForm) {
                        searchForms.forEach(form => {
                            if (form !== mainForm && form.closest('#search-results')) {
                                console.log('Removing duplicate search form');
                                form.remove();
                            }
                        });
                    }
                }
                
                // 2. Check for duplicate AI overviews
                const aiOverviews = document.querySelectorAll('#ai-overview-top');
                if (aiOverviews.length > 1) {
                    console.warn('Found multiple AI Overview elements, keeping only the first one');
                    // Keep only the first AI overview (the one at the top of the page)
                    for (let i = 1; i < aiOverviews.length; i++) {
                        if (aiOverviews[i].closest('#search-results')) {
                            console.log('Removing duplicate AI Overview');
                            aiOverviews[i].remove();
                        }
                    }
                }
                
                // 3. Check for duplicate navbars
                const navbars = document.querySelectorAll('nav.navbar');
                if (navbars.length > 1) {
                    console.warn('Found multiple navbars, keeping only the first one');
                    // Keep only the first navbar (the original one)
                    for (let i = 1; i < navbars.length; i++) {
                        navbars[i].remove();
                    }
                }
            });
            
            // Call when search results are loaded
            document.addEventListener("DOMContentLoaded", function () {
                const searchResults = document.getElementById("search-results");
                if (searchResults) {
                    // Use a MutationObserver to detect when search results are loaded
                    const observer = new MutationObserver(function (mutations) {
                        // Check if biohack sections are loaded
                        if (document.querySelector(".biohack-section")) {
                            generateBiohackTypeFilters();
                            
                            // Check if there's a hash in the URL and apply the appropriate filter
                            handleHashChange();
                            
                            // Once filters are generated, disconnect the observer
                            observer.disconnect();
                        }
                    });

                    observer.observe(searchResults, {
                        childList: true,
                        subtree: true,
                    });
                }
                
                // Listen for hash changes to update filters
                window.addEventListener('hashchange', handleHashChange);
            });

            // Function that previously updated the counts display - now just a placeholder
            // since we've removed the count display elements
            function updateFilterCounts(sourceType) {
                // This function is kept for compatibility but no longer does anything
                return;
            }
            
            // Function to clear the AI Overview when a new search is submitted
            // Function to prevent form submission if a downward swipe was detected
            function preventSubmitOnSwipe(event) {
                const form = event.target.closest('form');
                
                if (form && form.hasAttribute('data-prevent-submit')) {
                    console.log('Preventing form submission due to downward swipe');
                    // Remove the attribute after preventing submission
                    form.removeAttribute('data-prevent-submit');
                    // Prevent the form from submitting
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
                
                // If no swipe prevention is active, proceed with clearing AI Overview
                return clearAIOverview();
            }
            
            function clearAIOverview() {
                console.log('Clearing AI Overview for new search');
                
                // Hide the AI Overview top section
                const aiOverviewTop = document.getElementById('ai-overview-top');
                if (aiOverviewTop) {
                    aiOverviewTop.classList.add('d-none');
                }
                
                // Clear all containers
                const containers = [
                    'cool-biohacks-top', 'contra-biohacks-top', 'balance-biohacks-top', 'mechanisms-top',
                    'cool-biohacks-top-expanded', 'contra-biohacks-top-expanded', 'balance-biohacks-top-expanded', 'mechanisms-top-expanded'
                ];
                
                containers.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                
                // Reset to collapsed view
                const collapsedView = document.getElementById('summary-collapsed-top');
                const expandedView = document.getElementById('summary-expanded-top');
                const button = document.getElementById('show-more-btn-top');
                
                if (collapsedView && expandedView && button) {
                    collapsedView.classList.remove('d-none');
                    expandedView.classList.add('d-none');
                    button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg> Show more';
                }
                
                // Also clear the hidden mechanisms data
                const hiddenMechanisms = document.getElementById('hidden-mechanisms');
                if (hiddenMechanisms) {
                    hiddenMechanisms.setAttribute('data-mechanisms', '');
                }
                
                return true; // Allow the form submission to proceed
            }
            
            // Function to toggle the top AI Overview between collapsed and expanded views
            function toggleSummaryTop() {
                const collapsedView = document.getElementById('summary-collapsed-top');
                const expandedView = document.getElementById('summary-expanded-top');
                const button = document.getElementById('show-more-btn-top');
                
                if (!collapsedView || !expandedView || !button) return;
                
                if (collapsedView.classList.contains('d-none')) {
                    // Currently showing expanded view, switch to collapsed
                    collapsedView.classList.remove('d-none');
                    expandedView.classList.add('d-none');
                    button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg> Show more';
                } else {
                    // Currently showing collapsed view, switch to expanded
                    collapsedView.classList.add('d-none');
                    expandedView.classList.remove('d-none');
                    button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1"><path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"></path></svg> Show less';
                }
            }
            
            // Function to update the AI Overview at the top based on summary content
            function updateAIOverviewTop() {
                console.log('updateAIOverviewTop called');
                
                // Check if summary is finished and the content is available
                const summaryContent = document.getElementById('summary-content');
                const aiOverviewTop = document.getElementById('ai-overview-top');
                const summaryResult = document.getElementById('summary-result');
                
                // Hide the bottom summary result container (we only want the top one)
                if (summaryResult) {
                    console.log('Hiding bottom summary container');
                    summaryResult.classList.add('d-none');
                }
                
                if (summaryContent && aiOverviewTop) {
                    // Keep the top AI Overview hidden
                    aiOverviewTop.classList.add('d-none');
                    
                    // Extract content from the original summary section - each column contains its own lists
                    const columns = summaryContent.querySelectorAll('.col-md-4');
                    
                    if (columns.length >= 3) {
                        const coolBiohacks = columns[0].querySelectorAll('.list-group-item');
                        const contraBiohacks = columns[1].querySelectorAll('.list-group-item');
                        const balanceBiohacks = columns[2].querySelectorAll('.list-group-item');
                        
                        // Get the target containers
                        const coolTopContainer = document.getElementById('cool-biohacks-top');
                        const contraTopContainer = document.getElementById('contra-biohacks-top');
                        const balanceTopContainer = document.getElementById('balance-biohacks-top');
                        
                        const coolExpandedContainer = document.getElementById('cool-biohacks-top-expanded');
                        const contraExpandedContainer = document.getElementById('contra-biohacks-top-expanded');
                        const balanceExpandedContainer = document.getElementById('balance-biohacks-top-expanded');
                        
                        // Get mechanisms containers
                        const mechanismsTopContainer = document.getElementById('mechanisms-top');
                        const mechanismsExpandedContainer = document.getElementById('mechanisms-top-expanded');
                        
                        // Clear all containers
                        [coolTopContainer, coolExpandedContainer, contraTopContainer, contraExpandedContainer, 
                         balanceTopContainer, balanceExpandedContainer, mechanismsTopContainer, mechanismsExpandedContainer].forEach(container => {
                            if (container) container.innerHTML = '';
                        });
                        
                        // Helper function to create card items with proper styling
                        function createCardItem(text, icon, iconClass) {
                            const div = document.createElement('div');
                            div.className = 'mb-2';
                            
                            const iconEl = document.createElement('i');
                            iconEl.className = icon + ' ' + iconClass + ' me-1';
                            
                            div.appendChild(iconEl);
                            div.insertAdjacentHTML('beforeend', ' ' + text);
                            return div;
                        }
                        
                        // Function to handle showing or hiding a card column based on content
                        function toggleCardVisibility(itemsList, containerCollapsed, containerExpanded, cardCol, iconClass, iconColor) {
                            // Show placeholder content when no data is available
                            const showPlaceholder = !itemsList || itemsList.length === 0;
                            
                            // Always show the card column when containers exist
                            if (containerCollapsed && containerExpanded && cardCol) {
                                cardCol.classList.remove('d-none');
                                
                                // Clear existing content
                                containerCollapsed.innerHTML = '';
                                containerExpanded.innerHTML = '';
                                
                                if (!showPlaceholder && itemsList.length > 0) {
                                    // Add actual items to both containers
                                    itemsList.forEach(item => {
                                        const text = item.innerHTML?.replace(/<i[^>]*><\/i>\s*/, '') || item.textContent || '';
                                        if (text.trim()) { // Only add non-empty items
                                            if (containerCollapsed) {
                                                containerCollapsed.appendChild(createCardItem(text, iconClass, iconColor));
                                            }
                                            if (containerExpanded) {
                                                containerExpanded.appendChild(createCardItem(text, iconClass, iconColor));
                                            }
                                        }
                                    });
                                    return true; // Card has content
                                } else {
                                    // Add placeholder content
                                    const placeholderText = "Check back later for insights";
                                    
                                    if (containerCollapsed) {
                                        containerCollapsed.appendChild(createCardItem(placeholderText, "bi bi-info-circle", "text-muted"));
                                    }
                                    if (containerExpanded) {
                                        containerExpanded.appendChild(createCardItem(placeholderText, "bi bi-info-circle", "text-muted"));
                                    }
                                    return true; // Card has placeholder content
                                }
                            } else {
                                // Hide the card column if containers don't exist
                                if (cardCol) {
                                    cardCol.classList.add('d-none');
                                }
                                return false; // Card is empty
                            }
                        }
                        
                        // Get parent column elements for each card
                        const coolCol = coolTopContainer ? coolTopContainer.closest('.col') : null;
                        const contraCol = contraTopContainer ? contraTopContainer.closest('.col') : null;
                        const balanceCol = balanceTopContainer ? balanceTopContainer.closest('.col') : null;
                        const mechanismsCol = mechanismsTopContainer ? mechanismsTopContainer.closest('.col') : null;
                        
                        // Toggle visibility for each section's cards
                        const hasCool = toggleCardVisibility(coolBiohacks, coolTopContainer, coolExpandedContainer, coolCol, 'bi bi-check-circle-fill', 'text-success');
                        const hasContra = toggleCardVisibility(contraBiohacks, contraTopContainer, contraExpandedContainer, contraCol, 'bi bi-exclamation-triangle-fill', 'text-warning');
                        const hasBalance = toggleCardVisibility(balanceBiohacks, balanceTopContainer, balanceExpandedContainer, balanceCol, 'bi bi-arrow-repeat', 'text-info');
                        
                        // Get mechanisms from the main content or from the mechanisms property
                        // Try to find mechanisms in the DOM first
                        const mechanismsItems = document.querySelectorAll('.mechanisms-item');
                        let hasMechanisms = false;
                        
                        if (mechanismsItems.length > 0 && mechanismsTopContainer && mechanismsExpandedContainer) {
                            // Show mechanisms card
                            if (mechanismsCol) mechanismsCol.classList.remove('d-none');
                            
                            mechanismsItems.forEach(item => {
                                const text = item.innerHTML.replace(/<i[^>]*><\/i>\s*/, '');
                                if (text.trim()) {
                                    mechanismsTopContainer.appendChild(createCardItem(text, 'bi bi-gear-fill', 'text-success'));
                                    mechanismsExpandedContainer.appendChild(createCardItem(text, 'bi bi-gear-fill', 'text-success'));
                                    hasMechanisms = true;
                                }
                            });
                        }
                        
                        // If no mechanisms found in DOM, try to get them from the hidden container
                        if (!hasMechanisms) {
                            const hiddenMechanismsContainer = document.getElementById('hidden-mechanisms');
                            if (hiddenMechanismsContainer && hiddenMechanismsContainer.dataset.mechanisms) {
                                try {
                                    const mechanismsData = hiddenMechanismsContainer.dataset.mechanisms;
                                    // Check if there's actual JSON data to parse
                                    if (mechanismsData && mechanismsData.trim() !== '' && mechanismsData !== '[]') {
                                        const mechanisms = JSON.parse(mechanismsData);
                                        if (Array.isArray(mechanisms) && mechanisms.length > 0 && 
                                            mechanismsTopContainer && mechanismsExpandedContainer) {
                                            
                                            // Show mechanisms card
                                            if (mechanismsCol) mechanismsCol.classList.remove('d-none');
                                            
                                            mechanisms.forEach(mechanism => {
                                                if (mechanism && mechanism.trim()) {
                                                    mechanismsTopContainer.appendChild(createCardItem(mechanism, 'bi bi-gear-fill', 'text-success'));
                                                    mechanismsExpandedContainer.appendChild(createCardItem(mechanism, 'bi bi-gear-fill', 'text-success'));
                                                    hasMechanisms = true;
                                                }
                                            });
                                        }
                                    } else {
                                        // Show placeholder for mechanisms
                                        if (mechanismsTopContainer && mechanismsExpandedContainer && mechanismsCol) {
                                            mechanismsCol.classList.remove('d-none');
                                            mechanismsTopContainer.appendChild(createCardItem("Check back later for mechanism insights", "bi bi-info-circle", "text-muted"));
                                            mechanismsExpandedContainer.appendChild(createCardItem("Check back later for mechanism insights", "bi bi-info-circle", "text-muted"));
                                            hasMechanisms = true;
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error parsing mechanisms data:', e);
                                    // Still show placeholder on error
                                    if (mechanismsTopContainer && mechanismsExpandedContainer && mechanismsCol) {
                                        mechanismsCol.classList.remove('d-none');
                                        mechanismsTopContainer.appendChild(createCardItem("Check back later for mechanism insights", "bi bi-info-circle", "text-muted"));
                                        mechanismsExpandedContainer.appendChild(createCardItem("Check back later for mechanism insights", "bi bi-info-circle", "text-muted"));
                                        hasMechanisms = true;
                                    }
                                }
                            } else {
                                // Show placeholder if container doesn't exist or has no data
                                if (mechanismsTopContainer && mechanismsExpandedContainer && mechanismsCol) {
                                    mechanismsCol.classList.remove('d-none');
                                    mechanismsTopContainer.appendChild(createCardItem("Check back later for mechanism insights", "bi bi-info-circle", "text-muted"));
                                    mechanismsExpandedContainer.appendChild(createCardItem("Check back later for mechanism insights", "bi bi-info-circle", "text-muted"));
                                    hasMechanisms = true;
                                }
                            }
                        }
                        
                        // Always hide the AI Overview
                        console.log('Keeping AI Overview hidden');
                        if (aiOverviewTop) {
                            aiOverviewTop.classList.add('d-none');
                        }
                    }
                }
            }
            
            // Handle positioning with the new layout (AI Overview at the top)
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize the AI Overview when the page loads if question exists
                const urlParams = new URLSearchParams(window.location.search);
                const hasQuestion = urlParams.has('question');
                
                // Always try to update AI Overview on page load when question exists
                if (hasQuestion) {
                    // Try to update on page load
                    updateAIOverviewTop();
                    
                    // And again after a short delay to ensure all content is loaded
                    setTimeout(updateAIOverviewTop, 500);
                }
                
                adjustFilterPosition();
                
                // Recalculate when window is resized
                window.addEventListener('resize', adjustFilterPosition);
                
                // Listen for HTMX events to update the UI
                document.body.addEventListener('htmx:afterSwap', function(event) {
                    // Check if this was the summary swap
                    if (event.detail.target && 
                        (event.detail.target.id === 'summary-container-wrapper' || 
                         event.detail.target.id === 'summary-content')) {
                        // Wait a moment for DOM to update
                        setTimeout(() => {
                            // Call the update function to populate the top container
                            updateAIOverviewTop();
                            
                            // Make sure the bottom container is hidden
                            const summaryResult = document.getElementById('summary-result');
                            if (summaryResult) {
                                console.log('Hiding bottom summary after swap');
                                summaryResult.classList.add('d-none');
                            }
                        }, 100);
                    }
                });
                
                function adjustFilterPosition() {
                    const filterNav = document.getElementById('filter-nav');
                    
                    {% if summary_polling == "finished" %}
                    // After polling finishes, AI Overview is at the top of the page
                    // Set filter nav to a fixed position below the search bar
                    if (filterNav) {
                        filterNav.style.top = '70px';
                    }
                    {% else %}
                    // During polling, adjust based on summary area
                    const summaryArea = document.getElementById('summary-area');
                    if (summaryArea && filterNav) {
                        const summaryHeight = summaryArea.offsetHeight;
                        filterNav.style.top = (summaryHeight + 5) + 'px';
                    }
                    {% endif %}
                }
                
                // Also adjust when HTMX content is swapped
                document.addEventListener('htmx:afterSwap', function() {
                    setTimeout(adjustFilterPosition, 100);
                });
            });
        </script>
    </body>
</html>
